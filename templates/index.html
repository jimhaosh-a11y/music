<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vutron Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä¿åº•æ¨£å¼ï¼šè¬ä¸€ Tailwind æ²’è¼‰å…¥ï¼Œè‡³å°‘èƒŒæ™¯è¦æ˜¯é»‘çš„ */
        body { background-color: #111; color: #eee; font-family: sans-serif; overflow: hidden; }
        
        /* æ­Œè©åˆ—è¡¨çš„æ²è»¸éš±è— */
        #lyrics-wrapper::-webkit-scrollbar { display: none; }
        
        /* å‹•æ…‹æ­Œè©çš„æ ¸å¿ƒæ¨£å¼ */
        .lyric-line {
            transition: all 0.3s ease;
            opacity: 0.4;
            transform: scale(0.95);
            margin: 20px 0;
            cursor: pointer;
            filter: blur(1px); /* æœªå”±åˆ°çš„æ¨¡ç³Š */
        }
        
        /* å”±åˆ°çš„é‚£ä¸€å¥ï¼šè®Šäº®ã€è®Šå¤§ã€æ¸…æ™° */
        .lyric-line.active {
            opacity: 1;
            transform: scale(1.1);
            color: #fff;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            filter: blur(0);
        }

        /* å¦‚æœæ²’æœ‰æ­Œè©æ™‚çš„é¡¯ç¤º */
        .no-lyrics { color: #666; font-size: 1.5rem; margin-top: 100px; }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen flex">

    <div class="w-1/4 h-full bg-black/40 border-r border-white/10 flex flex-col">
        <div class="p-4 border-b border-white/10 font-bold text-xl text-pink-500">
            æˆ‘çš„æ­Œå–®
        </div>
        <div id="song-list" class="flex-1 overflow-y-auto p-2 space-y-1">
            <div class="text-gray-500 p-2 text-sm">æ­£åœ¨è®€å–...</div>
        </div>
    </div>

    <div class="flex-1 flex flex-col relative">
        <div class="absolute inset-0 bg-gradient-to-br from-indigo-900/50 to-black pointer-events-none"></div>

        <div id="lyrics-wrapper" class="flex-1 overflow-y-auto relative z-10 flex flex-col items-center py-40 scroll-smooth">
            <div id="lyrics-container" class="text-center w-full max-w-2xl px-4">
                <p class="no-lyrics">è«‹é»æ“Šå·¦å´æ­Œæ›²é–‹å§‹æ’­æ”¾</p>
            </div>
        </div>

        <div class="h-24 bg-black/60 backdrop-blur-md border-t border-white/10 flex items-center px-6 z-20 gap-4">
            <div class="w-1/4">
                <div id="current-title" class="font-bold truncate">---</div>
                <div id="current-artist" class="text-xs text-gray-400 truncate">---</div>
            </div>
            
            <audio id="audio" class="flex-1 h-10 rounded-full" controls></audio>
            
            <div class="w-1/4"></div>
        </div>
    </div>

    <script>
        const songListEl = document.getElementById('song-list');
        const lyricsContainer = document.getElementById('lyrics-container');
        const lyricsWrapper = document.getElementById('lyrics-wrapper'); // ç”¨ä¾†æ²å‹•çš„å®¹å™¨
        const audio = document.getElementById('audio');
        
        let lyricsData = []; // å­˜è§£æå¾Œçš„æ­Œè©ï¼š[{time: 12.5, text: "æ­Œè©", id: "line-0"}]

        // 1. è¼‰å…¥æ­Œå–®
        async function loadSongs() {
            try {
                const res = await fetch('/api/songs');
                const songs = await res.json();
                
                songListEl.innerHTML = '';
                if (songs.length === 0) {
                    songListEl.innerHTML = '<div class="p-4 text-red-400">æ‰¾ä¸åˆ° .mp3 æª”æ¡ˆ</div>';
                    return;
                }

                songs.forEach(song => {
                    const div = document.createElement('div');
                    div.className = "p-3 hover:bg-white/10 rounded cursor-pointer transition-colors group";
                    div.innerHTML = `
                        <div class="text-sm font-medium text-gray-200 group-hover:text-white">${song.title}</div>
                        <div class="text-xs text-gray-500">${song.artist}</div>
                    `;
                    div.onclick = () => playSong(song);
                    songListEl.appendChild(div);
                });
            } catch (err) {
                console.error(err);
                songListEl.innerHTML = '<div class="p-4 text-red-500">é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¢ºèª python æœ‰åœ¨è·‘</div>';
            }
        }

        // 2. æ’­æ”¾é‚è¼¯
        async function playSong(song) {
            // æ›´æ–° UI
            document.getElementById('current-title').innerText = song.title;
            document.getElementById('current-artist').innerText = song.artist;
            lyricsContainer.innerHTML = '<p class="no-lyrics animate-pulse">æ­£åœ¨æœå°‹æ­Œè©...</p>';
            
            // æ’­æ”¾
            audio.src = song.url;
            audio.play();

            // æŠ“æ­Œè©
            try {
                const res = await fetch(`/api/lyrics?title=${encodeURIComponent(song.title)}&artist=${encodeURIComponent(song.artist)}`);
                const data = await res.json();
                
                if (data.lyrics && data.lyrics.trim() !== "") {
                    // æª¢æŸ¥æ˜¯ä¸æ˜¯ LRC æ ¼å¼ (æœ‰æ²’æœ‰æ™‚é–“æ¨™ç±¤)
                    if (data.lyrics.indexOf('[') !== -1) {
                        parseLyrics(data.lyrics);
                    } else {
                        // ç´”æ–‡å­—æ­Œè©ï¼Œç„¡æ³•åŒæ­¥
                        lyricsData = [];
                        lyricsContainer.innerHTML = `<p class="whitespace-pre-wrap text-lg text-gray-400 leading-loose">${data.lyrics}</p>`;
                    }
                } else {
                    lyricsContainer.innerHTML = '<p class="no-lyrics">æ‰¾ä¸åˆ°æ­Œè© ğŸ¥²</p>';
                    lyricsData = [];
                }
            } catch (e) {
                lyricsContainer.innerHTML = '<p class="no-lyrics">æ­Œè©è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // 3. è§£æ [00:00.00] æ ¼å¼
        function parseLyrics(lrcText) {
            lyricsContainer.innerHTML = '';
            lyricsData = [];
            
            const lines = lrcText.split('\n');
            const timeRegex = /\[(\d{2}):(\d{2}\.\d{2,3})\](.*)/;

            lines.forEach((line, index) => {
                const match = timeRegex.exec(line);
                if (match) {
                    const minutes = parseInt(match[1]);
                    const seconds = parseFloat(match[2]);
                    const time = minutes * 60 + seconds;
                    const text = match[3].trim();
                    
                    if (text) { // å¿½ç•¥ç©ºè¡Œ
                        const p = document.createElement('p');
                        p.id = `line-${index}`;
                        p.className = "lyric-line text-xl md:text-3xl";
                        p.innerText = text;
                        // é»æ­Œè©å¯ä»¥è·³è½‰æ™‚é–“
                        p.onclick = () => { audio.currentTime = time; };
                        
                        lyricsContainer.appendChild(p);
                        lyricsData.push({ time, element: p });
                    }
                }
            });
        }

        // 4. åŒæ­¥æ²å‹•é‚è¼¯ (æœ€é‡è¦çš„åœ°æ–¹)
        audio.addEventListener('timeupdate', () => {
            if (!lyricsData.length) return;

            const currentTime = audio.currentTime;
            
            // æ‰¾å‡ºç›®å‰æ‡‰è©²äº®èµ·å“ªä¸€å¥
            // é‚è¼¯ï¼šæ‰¾ã€Œæœ€å¾Œä¸€å¥ã€å…¶æ™‚é–“å°æ–¼ç­‰æ–¼ç•¶å‰æ™‚é–“
            let activeIndex = -1;
            for (let i = 0; i < lyricsData.length; i++) {
                if (currentTime >= lyricsData[i].time) {
                    activeIndex = i;
                } else {
                    break; 
                }
            }

            if (activeIndex !== -1) {
                // æ¸…é™¤èˆŠçš„ active
                const currentActive = document.querySelector('.lyric-line.active');
                if (currentActive) currentActive.classList.remove('active');

                // è¨­å®šæ–°çš„ active
                const activeLine = lyricsData[activeIndex].element;
                activeLine.classList.add('active');

                // æ²å‹•è‡³ç•«é¢ä¸­é–“
                activeLine.scrollIntoView({ behavior: "smooth", block: "center" });
            }
        });

        // å•Ÿå‹•
        loadSongs();
    </script>
</body>
</html>